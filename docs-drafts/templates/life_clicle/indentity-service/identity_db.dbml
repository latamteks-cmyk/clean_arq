// Identity Service — SmartEdify Platform
// Basado en Documento de Visión v1.1, ADRs y Threat Model v4.4
// Octubre 2025

Table tenants {
  id uuid [primary key, note: 'UUID v4']
  name varchar(255) [not null]
  jurisdiction varchar(10) [not null, note: 'ISO 3166-1 alpha-2']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}

Table identities {
  id uuid [primary key, note: 'sub global único']
  tenant_id uuid [ref: > tenants.id, not null]
  subject_type varchar(50) [not null, note: 'human.end_user, service.principal, etc.']
  status varchar(20) [not null, default: 'pending', note: 'pending | active | suspended | deleted']
  created_at timestamp [default: `now()`]
  activated_at timestamp
  deleted_at timestamp
  Indexes {
    (tenant_id, id) [unique]
    status
  }
}

Table webauthn_credentials {
  id varchar(255) [primary key, note: 'credentialId base64url']
  identity_id uuid [ref: > identities.id, not null]
  tenant_id uuid [ref: > tenants.id, not null]
  public_key bytea [not null, note: 'CBOR-encoded COSE_Key']
  sign_count bigint [not null, default: 0]
  attestation_type varchar(20) [not null, note: 'none | basic | attested']
  aaguid uuid [note: 'FIDO2 authenticator model']
  device_type varchar(20) [not null, note: 'platform | cross-platform']
  backed_up boolean [not null, default: false]
  created_at timestamp [default: `now()`]
  last_used_at timestamp
  revoked_at timestamp
  Indexes {
    (identity_id)
    (tenant_id, id)
  }
}

Table sessions {
  id uuid [primary key]
  identity_id uuid [ref: > identities.id, not null]
  tenant_id uuid [ref: > tenants.id, not null]
  device_id varchar(255) [not null]
  cnf_jkt varchar(255) [not null, note: 'JWK Thumbprint SHA256']
  issued_at timestamp [not null, default: `now()`]
  not_after timestamp [not null, note: 'TTL ≤ 10 min']
  version int [not null, default: 1]
  revoked boolean [not null, default: false]
  Indexes {
    (identity_id, revoked)
    (tenant_id, device_id)
    not_after [type: btree]
  }
}

Table refresh_tokens {
  token_hash varchar(255) [primary key, note: 'SHA256(token)']
  session_id uuid [ref: > sessions.id, not null]
  tenant_id uuid [ref: > tenants.id, not null]
  used boolean [not null, default: false]
  issued_at timestamp [not null, default: `now()`]
  expires_at timestamp [not null]
  family_id uuid [not null, note: 'Rotación: misma familia = mismo root']
  Indexes {
    (session_id)
    (tenant_id, family_id)
  }
}

Table consent_audits {
  id uuid [primary key]
  identity_id uuid [ref: > identities.id, not null]
  tenant_id uuid [ref: > tenants.id, not null]
  version varchar(20) [not null]
  content_hash varchar(255) [not null, note: 'SHA256 del texto legal']
  accepted_at timestamp [not null, default: `now()`]
  ip_address inet
  user_agent text
  // WORM: sin updates ni deletes
}

Table dsar_jobs {
  job_id uuid [primary key]
  identity_id uuid [ref: > identities.id, not null]
  tenant_id uuid [ref: > tenants.id, not null]
  action varchar(20) [not null, note: 'export | delete']
  status varchar(20) [not null, default: 'accepted', note: 'accepted | processing | completed | failed']
  created_at timestamp [default: `now()`]
  completed_at timestamp
  result_url varchar(512) [note: 'URL firmada, expira en 48h']
  Indexes {
    (identity_id, action)
    status
  }
}

Table contextual_tokens {
  jti uuid [primary key]
  issuer varchar(255) [not null, note: 'https://auth.smartedify.global/{tenant_id}']
  tenant_id uuid [ref: > tenants.id, not null]
  subject uuid [ref: > identities.id, not null]
  audience varchar(255) [not null]
  event_id varchar(255) [not null]
  location varchar(255)
  cnf_jkt varchar(255) [not null]
  issued_at timestamp [not null, default: `now()`]
  expires_at timestamp [not null, note: 'TTL ≤ 300s']
  used boolean [not null, default: false]
  used_at timestamp
  Indexes {
    (jti)
    (tenant_id, event_id)
    expires_at [type: btree]
  }
}

Table revocation_events {
  id uuid [primary key]
  tenant_id uuid [ref: > tenants.id, not null]
  subject uuid [ref: > identities.id, not null]
  not_before timestamp [not null, note: 'Todos los tokens con iat < not_before son inválidos']
  reason varchar(50) [not null, note: 'user_logout | admin_revoke | key_compromise']
  created_at timestamp [default: `now()`]
  Indexes {
    (tenant_id, subject)
    not_before [type: btree]
  }
}

Table key_metadata {
  kid varchar(255) [primary key]
  tenant_id uuid [ref: > tenants.id, not null]
  algorithm varchar(10) [not null, note: 'ES256 | EdDSA']
  public_key bytea [not null]
  created_at timestamp [not null, default: `now()`]
  activated_at timestamp [not null]
  revoked_at timestamp
  Indexes {
    (tenant_id, kid)
    (revoked_at)
  }
}

// Tabla de auditoría inmutable (WORM)
Table audit_logs {
  id uuid [primary key]
  event_type varchar(50) [not null]
  tenant_id uuid [ref: > tenants.id, not null]
  identity_id uuid
  payload jsonb [not null, note: 'Evento serializado (login, revoke, dsar, etc.)']
  recorded_at timestamp [not null, default: `now()`]
  hash_chain varchar(255) [note: 'SHA256(prev_hash + payload)']
  // Sin updates ni deletes
  Indexes {
    (event_type, recorded_at)
    (tenant_id, identity_id)
  }
}
