/*
 * ==============================================================================
 * ADVERTENCIA: ARCHIVO FINAL - NO MODIFICAR MANUALMENTE
 * ==============================================================================
 *
 * Este esquema de base de datos es la versión final de user-profiles-service
 * Ha sido revisado y aprobado por el equipo de arquitectura.
 *
 * Cualquier modificación debe realizarse a través de los procesos de gestión
 * de cambios del proyecto y la revisión de código correspondiente.
 *
 * Última actualización manual: 2025-10-04
 * Congelado por: [Edgar Gomez]
 *
 * ==============================================================================
 */

Enum tenant_type {
  ADMINISTRADORA
  JUNTA
}

Enum record_status {
  ACTIVE
  INACTIVE
}

Enum contact_role {
  LEGAL
  BILLING
  NOTICES
}

Enum verification_state {
  PENDING
  VERIFIED
  REJECTED
}

Table tenants {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-001; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  type tenant_type [note: 'origen=governance_event; evidencia=acta-2025-001; // "ADMINISTRADORA"']
  legal_name text [note: 'origen=identity_claims; evidencia=RUC:20601234567; // "Administración Andina S.A.C."']
  domicile_country char(2) [note: 'origen=identity_claims; evidencia=RUC:20601234567; // "PE"']
  notification_email text [note: 'origen=profile_consents; evidencia=consent-9f0a1c22; // "legal@andina.pe"']
  legal_representative_user_id uuid [note: 'origen=identity_claims; evidencia=user:9f0a1c22-7bcd-4b90-a111-55aa22bbcc33; // "9f0a1c22-7bcd-4b90-a111-55aa22bbcc33"']
  status record_status [note: 'origen=governance_event; evidencia=acta-2025-001; // "ACTIVE"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-001; // "2025-10-04T10:12:00Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-001; // "2025-10-04T10:12:00Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'UNIQUE (legal_name, domicile_country). RLS por tenant aplicada.'
  Indexes {
    (status) [name: 'idx_tenants_status']
    (legal_name, domicile_country) [unique, name: 'idx_tenants_legal_name_country_unique']
  }
}

Table tenant_tax_registrations {
  id uuid [pk, note: 'origen=identity_claims; evidencia=id; // "7b1a9c22-8f40-4f35-8b1e-1c2d3e4f5a60"']
  tenant_id uuid [not null, note: 'origen=identity_claims; evidencia=tenant:id; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  rule_id uuid [note: 'origen=compliance_policy; evidencia=rule:PE-RUC-v1; // "11111111-aaaa-4bbb-cccc-222222222333"']
  id_number text [note: 'origen=identity_claims; evidencia=SUNAT-lookup; // "20601234567"']
  verification_status verification_state [note: 'origen=compliance_policy; evidencia=SUNAT-lookup; // "VERIFIED"']
  verified_at timestamptz [note: 'origen=compliance_policy; evidencia=SUNAT-lookup; // "2025-01-05T14:22:00Z"']
  is_primary bool [note: 'origen=compliance_policy; evidencia=rule:primary; // "true"']
  created_at timestamptz [note: 'origen=identity_claims; evidencia=event:create; // "2025-01-05T14:20:00Z"']
  updated_at timestamptz [note: 'origen=identity_claims; evidencia=event:update; // "2025-01-05T14:22:01Z"']
  deleted_at timestamptz [note: 'origen=identity_claims; evidencia=event:delete; // "null"']

  Note: 'UNIQUE (tenant_id, rule_id) y UNIQUE (rule_id, id_number). Solo 1 is_primary=TRUE por tenant.'
  Indexes {
    (tenant_id) [name: 'idx_ttr_tenant']
    (verification_status) [name: 'idx_ttr_status']
    (tenant_id, rule_id) [unique, name: 'idx_ttr_tenant_rule_unique']
    (rule_id, id_number) [unique, name: 'idx_ttr_rule_number_unique']
  }
}

Table tenant_contacts {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-002; // "8c0f6a77-2b21-4c4e-9a99-1d2e3f4a5b6c"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-002; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  role contact_role [note: 'origen=governance_event; evidencia=acta-2025-002; // "LEGAL"']
  user_id uuid [note: 'origen=identity_claims; evidencia=user:9f0a1c22; // "9f0a1c22-7bcd-4b90-a111-55aa22bbcc33"']
  email text [note: 'origen=profile_consents; evidencia=consent-9f0a1c22; // "representante.legal@ejemplo.pe"']
  phone text [note: 'origen=profile_consents; evidencia=consent-9f0a1c22; // "+51-1-555-0101"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-002; // "2025-10-04T10:12:30Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-002; // "2025-10-04T10:12:30Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'Contactos directos del tenant (ej: administradora)'
  Indexes {
    (tenant_id) [name: 'idx_tenant_contacts_tenant']
    (tenant_id, role) [name: 'idx_tenant_contacts_role']
  }
}

Table condominiums {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-010; // "6a2b7b61-3d1a-4f2e-8d74-9f2c1a7b3e55"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-010; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  name text [note: 'origen=governance_event; evidencia=acta-2025-010; // "Residencial Las Lomas"']
  country_code char(2) [note: 'origen=governance_event; evidencia=acta-2025-010; // "PE"']
  notification_email text [note: 'origen=profile_consents; evidencia=consent-condo-001; // "junta.las.lomas@ejemplo.pe"']
  default_billing_currency char(3) [note: 'origen=compliance_policy; evidencia=PE.ALLOWED_CURRENCIES; // "PEN"']
  status record_status [note: 'origen=governance_event; evidencia=acta-2025-010; // "ACTIVE"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-010; // "2025-10-04T10:13:00Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-010; // "2025-10-04T10:13:00Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'UNIQUE (tenant_id, name). FK compuesta requiere (id, tenant_id) único.'
  Indexes {
    (country_code) [name: 'idx_condos_country']
    (tenant_id, name) [unique, name: 'idx_condos_tenant_name_unique']
    (id, tenant_id) [unique, name: 'idx_condos_id_tenant_unique']
  }
}

Table condominium_contacts {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-012; // "f1e2d3c4-b5a6-4c7d-8e9f-0a1b2c3d4e5f"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-012; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  condominium_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-012; // "6a2b7b61-3d1a-4f2e-8d74-9f2c1a7b3e55"']
  role contact_role [note: 'origen=governance_event; evidencia=acta-2025-012; // "NOTICES"']
  user_id uuid [note: 'origen=identity_claims; evidencia=user:8a7b6c5d; // "8a7b6c5d-4e3f-2a1b-0c9d-8e7f6a5b4c3d"']
  email text [note: 'origen=profile_consents; evidencia=consent-8a7b6c5d; // "presidente@laslomas.pe"']
  phone text [note: 'origen=profile_consents; evidencia=consent-8a7b6c5d; // "+51-1-555-0202"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-012; // "2025-10-04T10:13:20Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-012; // "2025-10-04T10:13:20Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'Contactos por condominio (ej: junta de vecinos)'
  Indexes {
    (tenant_id, condominium_id) [name: 'idx_condo_contacts_condo']
    (tenant_id, condominium_id, role) [name: 'idx_condo_contacts_role']
  }
}

Table condominium_registrations {
  id uuid [pk, note: 'origen=document_vault; evidencia=doc:sunarp-P00012345; // "51e8f8f0-0f9a-4a3e-9d41-0c1ab2c3d4e5"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-011; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  condominium_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-011; // "6a2b7b61-3d1a-4f2e-8d74-9f2c1a7b3e55"']
  rule_id uuid [note: 'origen=compliance_policy; evidencia=rule:PE-SUNARP-v1; // "22222222-bbbb-4ccc-dddd-333333333444"']
  id_number text [note: 'origen=document_vault; evidencia=doc:sunarp-P00012345; // "P00012345"']
  valid_from date [note: 'origen=document_vault; evidencia=doc:sunarp-P00012345; // "2023-03-10"']
  valid_to date [note: 'origen=document_vault; evidencia=doc:sunarp-P00012345; // "null"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-011; // "2025-10-04T10:13:10Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-011; // "2025-10-04T10:13:10Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'CHECK (valid_to IS NULL OR valid_to >= valid_from). UNIQUE (condominium_id, tenant_id, rule_id)'
  Indexes {
    (tenant_id) [name: 'idx_cr_tenant']
    (condominium_id, tenant_id) [name: 'idx_cr_condo_tenant']
    (condominium_id, tenant_id, rule_id) [unique, name: 'idx_cr_condo_tenant_rule_unique']
  }
}

Table buildings {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-020; // "0a9c1f34-7e2b-4d0b-8a51-5c0c2de9f4aa"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-020; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  condominium_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-020; // "6a2b7b61-3d1a-4f2e-8d74-9f2c1a7b3e55"']
  name text [note: 'origen=governance_event; evidencia=acta-2025-020; // "Torre A"']
  levels int [note: 'origen=document_vault; evidencia=doc:plano-arquitectonico-A; // "12"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-020; // "2025-10-04T10:13:30Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-020; // "2025-10-04T10:13:30Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'UNIQUE (condominium_id, tenant_id, name). FK compuesta requiere (id, tenant_id) único.'
  Indexes {
    (tenant_id) [name: 'idx_buildings_tenant']
    (condominium_id, tenant_id) [name: 'idx_buildings_condo_tenant']
    (condominium_id, tenant_id, name) [unique, name: 'idx_buildings_condo_tenant_name_unique']
    (id, tenant_id) [unique, name: 'idx_buildings_id_tenant_unique']
  }
}

Table units {
  id uuid [pk, note: 'origen=governance_event; evidencia=acta-2025-021; // "d2f7a5c1-8a6b-4c2d-9e31-1b2a3c4d5e6f"']
  tenant_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-021; // "4f8f9b2e-9f9e-4e7e-9c4d-2c3a1b6f2a10"']
  building_id uuid [not null, note: 'origen=governance_event; evidencia=acta-2025-021; // "0a9c1f34-7e2b-4d0b-8a51-5c0c2de9f4aa"']
  local_code text [note: 'origen=document_vault; evidencia=doc:plano-unidades; // "A-804"']
  kind text [note: 'origen=governance_event; evidencia=acta-2025-021; // "PRIVATE"']
  common_type text [note: 'origen=governance_event; evidencia=acta-2025-021; // "null"']
  aliquot numeric(7,4) [note: 'origen=compliance_policy; evidencia=PE.ALIQUOT_PRECISION; // "0.0125"']
  floor text [note: 'origen=document_vault; evidencia=doc:plano-unidades; // "8"']
  area_m2 numeric(10,2) [note: 'origen=document_vault; evidencia=doc:plano-unidades; // "78.50"']
  meta jsonb [note: 'origen=document_vault; evidencia=doc:plano-unidades; // "{\"bedrooms\":2,\"bathrooms\":2}"']
  cost_center_id text [note: 'origen=governance_event; evidencia=acta-2025-030; // "CC-RES-01"']
  status record_status [note: 'origen=governance_event; evidencia=acta-2025-021; // "ACTIVE"']
  created_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-021; // "2025-10-04T10:15:00Z"']
  updated_at timestamptz [note: 'origen=governance_event; evidencia=acta-2025-021; // "2025-10-04T10:15:00Z"']
  deleted_at timestamptz [note: 'origen=governance_event; evidencia=null; // "null"']

  Note: 'UNIQUE (building_id, tenant_id, local_code). condominium_id derivable de building_id.'
  Indexes {
    (tenant_id) [name: 'idx_units_tenant']
    (tenant_id, building_id) [name: 'idx_units_tenant_building']
    (building_id, tenant_id, local_code) [unique, name: 'idx_units_building_tenant_local_unique']
    (id, tenant_id) [unique, name: 'idx_units_id_tenant_unique']
    (kind) [name: 'idx_units_kind']
  }
}

/* Relaciones compuestas para integridad multi-tenant */
Ref: tenant_tax_registrations.(tenant_id) > tenants.(id)
Ref: tenant_contacts.(tenant_id) > tenants.(id)
Ref: condominiums.(tenant_id) > tenants.(id)
Ref: condominium_contacts.(condominium_id, tenant_id) > condominiums.(id, tenant_id)
Ref: condominium_registrations.(condominium_id, tenant_id) > condominiums.(id, tenant_id)
Ref: buildings.(condominium_id, tenant_id) > condominiums.(id, tenant_id)
Ref: units.(building_id, tenant_id) > buildings.(id, tenant_id)
